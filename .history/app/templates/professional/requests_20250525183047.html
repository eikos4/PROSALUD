{% extends 'base.html' %}
{% block title %}Solicitudes recibidas{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-b from-[#f5f7fc] to-[#e6eefa] py-12">
  <div class="max-w-5xl mx-auto px-2 md:px-4">
    <div class="bg-white/95 rounded-2xl shadow-2xl border border-[#276EF1]/10 px-6 py-8 animate-fade-in">
      <h2 class="text-3xl font-extrabold text-[#276EF1] mb-8 flex items-center gap-3">
        <i class="fas fa-envelope-open-text text-[#FF8800]"></i>
        Solicitudes de clientes
      </h2>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-6">
            {% for category, msg in messages %}
              <div class="rounded-lg p-3 mb-2 text-center font-semibold
                {% if category == 'success' %}bg-green-100 text-green-800
                {% elif category == 'warning' %}bg-yellow-100 text-yellow-700
                {% elif category == 'danger' %}bg-red-100 text-red-700
                {% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ msg }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% if solicitudes %}
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-[#e6eefa] text-sm rounded-xl overflow-hidden shadow-lg">
            <thead class="bg-[#f5f7fc] text-[#164399] sticky top-0 z-10">
              <tr>
                <th class="px-6 py-4 text-left font-bold">Cliente</th>
                <th class="px-6 py-4 text-left font-bold">Servicio</th>
                <th class="px-6 py-4 text-left font-bold">Mensaje</th>
                <th class="px-6 py-4 text-center font-bold">Estado</th>
                <th class="px-6 py-4 text-center font-bold">Fecha</th>
                <th class="px-6 py-4 text-center font-bold">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[#f5f7fc] text-[#1E293B]">
              {% for req in solicitudes %}
              <tr class="hover:bg-[#eaf1fd] transition">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    <img src="{{ req.client.profile_image_url or url_for('static', filename='images/placeholder.png') }}" class="w-8 h-8 rounded-full border-2 border-[#276EF1]/30 shadow-sm" alt="Avatar cliente">
                    <span class="font-bold text-[#276EF1]">{{ req.client.username }}</span>
                  </div>
                </td>
                <td class="px-6 py-4 font-semibold text-[#164399]">{{ req.service.title }}</td>
                <td class="px-6 py-4 max-w-xs truncate" title="{{ req.message }}">
                  {{ req.message[:60] }}{% if req.message|length > 60 %}...{% endif %}
                </td>
                <td class="px-6 py-4 text-center">
                  {% if req.status == 'pending' %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold text-xs animate-pulse">
                      <i class="fas fa-hourglass-half"></i> Pendiente
                    </span>
                  {% elif req.status == 'accepted' %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold text-xs">
                      <i class="fas fa-check-circle"></i> Aceptada
                    </span>
                  {% elif req.status == 'rejected' %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-700 font-bold text-xs">
                      <i class="fas fa-times-circle"></i> Rechazada
                    </span>
                  {% elif req.status == 'completed' %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-800 font-bold text-xs">
                      <i class="fas fa-flag-checkered"></i> Completada
                    </span>
                  {% endif %}
                </td>
                <td class="px-6 py-4 text-center whitespace-nowrap">
                  {{ req.date_requested.strftime('%d-%m-%Y %H:%M') }}
                </td>
                <td class="px-6 py-4 text-center flex flex-col gap-2">
                  <a href="{{ url_for('professional.respond_request', request_id=req.id) }}"
                     class="inline-flex items-center gap-1 px-4 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded-lg font-semibold text-xs shadow transition"
                     title="Ver o responder solicitud">
                    <i class="fas fa-reply"></i> Ver / Responder
                  </a>
                  {% if req.status == 'accepted' %}
                    <!-- Botón para abrir modal -->
                    <button type="button"
                            onclick="openModal('modal-completar-{{ req.id }}')"
                            class="inline-block px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold text-xs shadow transition">
                      <i class="fas fa-flag-checkered"></i> Completar
                    </button>
                    <!-- Modal de confirmación -->
                    <div id="modal-completar-{{ req.id }}"
                         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden"
                         tabindex="-1" aria-modal="true" role="dialog">
                      <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full text-center relative animate-fade-in">
                        <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700" onclick="closeModal('modal-completar-{{ req.id }}')" aria-label="Cerrar">
                          <i class="fas fa-times text-xl"></i>
                        </button>
                        <h3 class="text-2xl font-bold text-[#276EF1] mb-4 flex items-center gap-2">
                          <i class="fas fa-exclamation-circle text-[#FF8800]"></i>
                          Confirmar finalización del servicio
                        </h3>
                        <ul class="text-left text-gray-600 mt-2 mb-4 list-disc list-inside">
                          <li>El trabajo fue realizado y entregado al cliente.</li>
                          <li>No podrás modificar el estado después de confirmar.</li>
                          <li>El cliente podrá dejar una evaluación sobre tu servicio.</li>
                        </ul>
                        <form method="POST" action="{{ url_for('professional.complete_request', request_id=req.id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <div class="flex gap-3 justify-center mt-6">
                            <button type="submit"
                                    class="px-6 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded font-bold shadow transition">
                              Sí, finalizar
                            </button>
                            <button type="button"
                                    onclick="closeModal('modal-completar-{{ req.id }}')"
                                    class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-[#276EF1] rounded font-bold shadow transition">
                              Cancelar
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="bg-white text-gray-400 rounded-lg p-8 mt-10 text-center shadow-md border border-[#276EF1]/10">
          <i class="fas fa-info-circle text-3xl mb-3 text-[#FF8800]"></i><br>
          <span class="block text-xl font-semibold mb-2 text-[#164399]">No tienes solicitudes por ahora.</span>
          <span class="text-sm text-[#276EF1]">Cuando un cliente te solicite un servicio, aparecerá aquí.</span>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
}
function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}
</script>
<style>
  @keyframes fade-in { from { opacity: 0; transform: scale(0.96);} to { opacity: 1; transform: scale(1);} }
  .animate-fade-in { animation: fade-in 0.18s ease; }
</style>
{% endblock %}
