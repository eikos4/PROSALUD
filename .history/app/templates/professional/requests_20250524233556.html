{% extends 'base.html' %}
{% block title %}Solicitudes recibidas{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-b from-[#f5f7fc] to-[#e6eefa] py-10">
  <div class="max-w-5xl mx-auto px-4">
    <h2 class="text-3xl font-black text-[#276EF1] mb-8 flex items-center gap-3">
      <i class="fas fa-envelope-open-text text-[#FF8800]"></i>
      Solicitudes de clientes
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6">
          {% for category, msg in messages %}
            <div class="rounded-lg p-3 mb-2 text-center
              {% if category == 'success' %}bg-green-100 text-green-800
              {% elif category == 'warning' %}bg-yellow-100 text-yellow-700
              {% elif category == 'danger' %}bg-red-100 text-red-700
              {% else %}bg-blue-100 text-blue-700{% endif %}">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if solicitudes %}
      <div class="overflow-x-auto bg-white rounded-xl shadow-md border border-[#e6eefa]/70">
        <table class="min-w-full divide-y divide-[#e6eefa]">
          <thead class="bg-[#f5f7fc] text-[#164399] sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3 text-left font-extrabold text-sm">Cliente</th>
              <th class="px-6 py-3 text-left font-extrabold text-sm">Servicio</th>
              <th class="px-6 py-3 text-left font-extrabold text-sm">Mensaje</th>
              <th class="px-6 py-3 text-center font-extrabold text-sm">Estado</th>
              <th class="px-6 py-3 text-center font-extrabold text-sm">Fecha</th>
              <th class="px-6 py-3 text-center font-extrabold text-sm">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[#f5f7fc] text-[#1E293B]">
            {% for req in solicitudes %}
            <tr class="hover:bg-[#f5f7fc] transition">
              <td class="px-6 py-4">{{ req.client.username }}</td>
              <td class="px-6 py-4">{{ req.service.title }}</td>
              <td class="px-6 py-4 max-w-xs truncate" title="{{ req.message }}">{{ req.message[:60] }}{% if req.message|length > 60 %}...{% endif %}</td>
              <td class="px-6 py-4 text-center">
                {% if req.status == 'pending' %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold text-xs">
                    <i class="fas fa-hourglass-half"></i> Pendiente
                  </span>
                {% elif req.status == 'accepted' %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold text-xs">
                    <i class="fas fa-check-circle"></i> Aceptada
                  </span>
                {% elif req.status == 'rejected' %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-700 font-bold text-xs">
                    <i class="fas fa-times-circle"></i> Rechazada
                  </span>
                {% elif req.status == 'completed' %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-800 font-bold text-xs">
                    <i class="fas fa-flag-checkered"></i> Completada
                  </span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-center">{{ req.date_requested.strftime('%d-%m-%Y %H:%M') }}</td>
              <td class="px-6 py-4 text-center flex flex-col gap-2">
                <a href="{{ url_for('professional.respond_request', request_id=req.id) }}"
                   class="inline-flex items-center gap-1 px-4 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded-lg font-semibold text-xs shadow transition"
                   title="Ver o responder solicitud">
                  <i class="fas fa-reply"></i> Ver / Responder
                </a>
                {% if req.status == 'accepted' %}
                 <form method="POST" action="{{ url_for('professional.complete_request', request_id=req.id) }}">
  {{ csrf_token() }}
  <button type="submit">Completar</button>
</form>

                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="bg-white text-gray-400 rounded-lg p-6 mt-10 text-center shadow">
        <i class="fas fa-info-circle text-2xl text-[#FF8800] mb-3"></i><br>
        No tienes solicitudes por ahora.
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}
