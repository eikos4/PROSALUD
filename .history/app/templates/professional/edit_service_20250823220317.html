{% extends 'base.html' %}
{% block title %}Editar servicio ‚Äì IndepSalud{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto py-10">

  <!-- SaniBot: encabezado -->
  <div class="bg-white rounded-2xl border border-indigo-100 shadow p-5 mb-6 flex items-start gap-4">
    <img src="{{ url_for('static', filename='images/sanibot.png') }}" alt="SaniBot" class="w-12 h-12 rounded-full shadow">
    <div class="flex-1">
      <h3 class="text-lg font-bold text-[#0d3b66]">Hola, soy SaniBot ü§ñ</h3>
      <p class="text-gray-600 mt-1">
        Aqu√≠ puedes <strong>mejorar la ficha</strong> de tu servicio. ¬øTe doy algunos consejos r√°pidos o un mini‚Äëtour del formulario?
      </p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnTourEditar" type="button"
          class="px-4 py-2 rounded-lg bg-[#276EF1] text-white font-semibold hover:bg-[#1E5BB8] shadow">
          Gu√≠a r√°pida del formulario
        </button>
        <button id="btnTipsEditar" type="button"
          class="px-4 py-2 rounded-lg bg-white text-[#276EF1] border border-[#276EF1]/40 font-semibold hover:bg-[#E6F2FF] shadow">
          Tips de redacci√≥n y precio
        </button>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 border border-[#276EF1]/20">
    <h2 class="text-3xl font-bold text-[#276EF1] mb-6 flex items-center gap-2">
      <i class="fas fa-edit"></i> Editar Servicio
    </h2>

    <form method="POST" class="space-y-6" id="form-editar-servicio">
      {{ form.hidden_tag() }}

      <!-- T√≠tulo -->
      <div id="field-titulo">
        <div class="flex items-center justify-between">
          {{ form.title.label(class_="block text-[#164399] font-extrabold mb-1") }}
          <button type="button" class="text-xs text-[#276EF1] underline sanibot-help" data-key="titulo">¬øQu√© es un buen t√≠tulo?</button>
        </div>
        {{ form.title(
          class_="form-control w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-500 bg-[#f7fafd] focus:outline-none focus:bg-[#e6eefa] focus:border-[#276EF1] transition",
          placeholder="Ejemplo: Consulta m√©dica general (30 minutos)"
        ) }}
        <div class="flex items-center justify-between mt-1">
          <small id="title-count" class="text-gray-500">0/80</small>
          <small id="title-hint" class="text-gray-400">S√© espec√≠fico y f√°cil de buscar.</small>
        </div>
        {% if form.title.errors %}
          <div class="text-red-500 text-sm mt-1">{{ form.title.errors[0] }}</div>
        {% endif %}
      </div>

      <!-- Descripci√≥n -->
      <div id="field-descripcion">
        <div class="flex items-center justify-between">
          {{ form.description.label(class_="block text-[#164399] font-extrabold mb-1") }}
          <button type="button" class="text-xs text-[#276EF1] underline sanibot-help" data-key="descripcion">¬øC√≥mo describir mejor?</button>
        </div>
        {{ form.description(
          class_="form-control w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-500 bg-[#f7fafd] focus:outline-none focus:bg-[#e6eefa] focus:border-[#276EF1] transition",
          rows=5,
          placeholder="Incluye: alcance, modalidad (online/presencial), duraci√≥n, preparaci√≥n del paciente y exclusiones."
        ) }}
        <div class="flex items-center justify-between mt-1">
          <small id="desc-count" class="text-gray-500">0/600</small>
          <small id="desc-hint" class="text-gray-400">M√≠n. recomendado 180 caracteres.</small>
        </div>
        {% if form.description.errors %}
          <div class="text-red-500 text-sm mt-1">{{ form.description.errors[0] }}</div>
        {% endif %}
      </div>

      <!-- Precio -->
      <div id="field-precio">
        <div class="flex items-center justify-between">
          {{ form.price.label(class_="block text-[#164399] font-extrabold mb-1") }}
          <button type="button" class="text-xs text-[#276EF1] underline sanibot-help" data-key="precio">Consejos de precio</button>
        </div>
        <div class="relative">
          {{ form.price(
            class_="form-control w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-500 bg-[#f7fafd] focus:outline-none focus:bg-[#e6eefa] focus:border-[#276EF1] transition pr-16",
            min=0,
            step="1",
            placeholder="Ejemplo: 25000"
          ) }}
          <span class="absolute right-4 top-3 text-gray-400 font-bold">CLP</span>
        </div>
        <div class="mt-1 text-sm text-gray-600">
          Vista previa: <span id="price-preview" class="font-semibold text-[#164399]">$‚Äî</span>
        </div>
        {% if form.price.errors %}
          <div class="text-red-500 text-sm mt-1">{{ form.price.errors[0] }}</div>
        {% endif %}
      </div>

      <div class="flex gap-3 mt-7">
        {{ form.submit(class_="px-6 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded-lg font-bold shadow transition") }}
        <a href="{{ url_for('professional.services') }}"
           class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-[#276EF1] rounded-lg font-bold shadow transition">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<!-- Modal SaniBot -->
<style>.sanibot-modal{display:none}</style>
<div id="sanibotEditarModal" class="sanibot-modal fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white max-w-2xl w-[92%] rounded-2xl shadow-2xl overflow-hidden">
    <div class="flex items-center gap-3 px-6 py-4 border-b">
      <img src="{{ url_for('static', filename='images/sanibot.png') }}" class="w-10 h-10" alt="SaniBot">
      <h3 id="sanibotEditarTitle" class="text-lg font-bold text-[#0d3b66]">Gu√≠a ‚Äî Editar servicio</h3>
    </div>
    <div id="sanibotEditarBody" class="p-6 space-y-4 text-sm text-gray-700">
      <!-- contenido din√°mico -->
    </div>
    <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2">
      <button id="sanibotEditarClose" type="button" class="px-4 py-2 rounded-lg border hover:bg-gray-100">Cerrar</button>
      <button id="sanibotEditarNext" type="button" class="px-4 py-2 rounded-lg bg-[#276EF1] text-white hover:bg-[#1E5BB8]">Siguiente</button>
    </div>
  </div>
</div>

<style>
  .ring-highlight { box-shadow: 0 0 0 4px rgba(39,110,241,.35); border-radius: .75rem; transition: box-shadow .25s ease; }
</style>

<script>
(function(){
  // Anclas para resaltar cada campo
  const anchors = {
    titulo: () => document.getElementById('field-titulo'),
    descripcion: () => document.getElementById('field-descripcion'),
    precio: () => document.getElementById('field-precio'),
  };

  // Pasos del tour
  const steps = [
    {
      key: 'titulo',
      title: 'T√≠tulo del servicio',
      html: `
        <p>Usa un t√≠tulo <strong>espec√≠fico</strong> y f√°cil de buscar (ej. ‚ÄúConsulta m√©dica general (30 min)‚Äù).</p>
        <ul class="list-disc list-inside space-y-1">
          <li>Incluye <em>modalidad</em> o <em>duraci√≥n</em> si aplica.</li>
          <li>Evita may√∫sculas sostenidas y siglas poco conocidas.</li>
        </ul>`
    },
    {
      key: 'descripcion',
      title: 'Descripci√≥n clara y completa',
      html: `
        <p>Explica el <strong>alcance</strong>, <strong>modalidad</strong>, <strong>duraci√≥n</strong>, preparaci√≥n del paciente y <strong>exclusiones</strong>.</p>
        <ul class="list-disc list-inside space-y-1">
          <li>Ej.: ‚ÄúConsulta online de 30 min. Incluye anamnesis y plan. No incluye ex√°menes‚Äù.</li>
          <li>Usa p√°rrafos cortos y vi√±etas para facilitar la lectura.</li>
        </ul>`
    },
    {
      key: 'precio',
      title: 'Precio y transparencia',
      html: `
        <p>Publica un precio <strong>claro</strong> y consistente con tus otros servicios.</p>
        <ul class="list-disc list-inside space-y-1">
          <li>Evita rangos ambiguos; si hay extras, acl√°ralos en la descripci√≥n.</li>
          <li>Revisa la vista previa en CLP antes de guardar.</li>
        </ul>`
    }
  ];

  const HCLASS = 'ring-highlight';

  // Modal
  const modal  = document.getElementById('sanibotEditarModal');
  const titleE = document.getElementById('sanibotEditarTitle');
  const bodyE  = document.getElementById('sanibotEditarBody');
  const nextB  = document.getElementById('sanibotEditarNext');
  const closeB = document.getElementById('sanibotEditarClose');

  let idx = 0;

  function openModal(){ modal.classList.remove('sanibot-modal'); document.body.classList.add('overflow-hidden'); }
  function closeModal(){ modal.classList.add('sanibot-modal'); document.body.classList.remove('overflow-hidden'); clearHighlight(); }
  function clearHighlight(){ document.querySelectorAll('.' + HCLASS).forEach(el => el.classList.remove(HCLASS)); }
  function renderStep(step){
    clearHighlight();
    titleE.textContent = step.title + ' ‚Äî SaniBot';
    bodyE.innerHTML = step.html;
    const target = anchors[step.key]?.();
    if (target) {
      target.classList.add(HCLASS);
      target.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }
  function startTour(){
    idx = 0; openModal(); renderStep(steps[idx]); nextB.textContent = 'Siguiente';
  }

  // Botones cabecera
  document.getElementById('btnTourEditar')?.addEventListener('click', startTour);
  document.getElementById('btnTipsEditar')?.addEventListener('click', ()=>{
    openModal();
    titleE.textContent = 'Tips de redacci√≥n y precio ‚Äî SaniBot';
    bodyE.innerHTML = `
      <ul class="list-disc list-inside space-y-2">
        <li><strong>Escribe para pacientes:</strong> evita tecnicismos innecesarios.</li>
        <li><strong>Beneficios primero:</strong> qu√© problema resuelve el servicio.</li>
        <li><strong>Consistencia:</strong> usa el mismo tono y formato en todos tus servicios.</li>
        <li><strong>Precio visible:</strong> aumenta la confianza y reduce fricci√≥n.</li>
      </ul>`;
    nextB.textContent = 'Entendido';
  });

  // Ayudas contextuales en cada campo
  document.querySelectorAll('.sanibot-help').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-key');
      const step = steps.find(s => s.key === key);
      if (!step) return;
      openModal(); renderStep(step);
      nextB.textContent = 'Entendido';
    });
  });

  // Navegaci√≥n modal
  nextB?.addEventListener('click', ()=>{
    if (nextB.textContent === 'Siguiente'){
      idx++;
      if (idx < steps.length) {
        renderStep(steps[idx]);
        if (idx === steps.length - 1) nextB.textContent = 'Finalizar';
      } else {
        closeModal();
      }
    } else {
      closeModal();
    }
  });
  closeB?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });

  // ===== Micro‚ÄëUX de campos =====
  const titleInput = document.getElementById('{{ form.title.id }}');
  const descInput  = document.getElementById('{{ form.description.id }}');
  const priceInput = document.getElementById('{{ form.price.id }}');

  // Contadores
  const titleCount = document.getElementById('title-count');
  const descCount  = document.getElementById('desc-count');

  function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }

  titleInput?.addEventListener('input', ()=>{
    const v = titleInput.value || '';
    titleCount.textContent = `${clamp(v.length,0,80)}/80`;
  });
  descInput?.addEventListener('input', ()=>{
    const v = descInput.value || '';
    descCount.textContent = `${clamp(v.length,0,600)}/600`;
  });

  // Vista previa de precio (CLP con miles)
  const preview = document.getElementById('price-preview');
  function formatCLP(n){
    if (n === '' || isNaN(n)) return '‚Äî';
    const i = Math.floor(parseFloat(n));
    return i.toLocaleString('es-CL', {maximumFractionDigits:0});
  }
  function updatePricePreview(){
    if (!priceInput) return;
    preview.textContent = '$' + formatCLP(priceInput.value);
  }
  priceInput?.addEventListener('input', updatePricePreview);
  updatePricePreview();

})();
</script>
{% endblock %}
