{% extends 'base.html' %}
{% block title %}Mis Servicios ‚Äì IndepSalud{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-12 px-2 md:px-0">

  <!-- Cabecera -->
  <div class="flex items-center gap-3 mb-6 animate-fade-in">
    <div class="bg-[#276EF1]/10 text-[#276EF1] p-3 rounded-full shadow">
      <i class="fas fa-stethoscope text-xl"></i>
    </div>
    <h2 class="text-3xl font-bold text-[#164399] tracking-tight">
      Servicios que ofreces en <span class="text-[#276EF1]">IndepSalud</span>
    </h2>
  </div>

  <!-- SaniBot gu√≠a -->
  <div class="bg-white rounded-2xl border border-indigo-100 shadow p-6 mb-10 flex items-start gap-4 animate-fade-in">
    <img src="{{ url_for('static', filename='images/sanibot.png') }}" alt="SaniBot" class="w-14 h-14 rounded-full shadow">
    <div class="flex-1">
      <h3 class="text-xl font-bold text-[#0d3b66]">Hola, soy SaniBot ü§ñ</h3>
      <p class="text-gray-600 mt-1">
        Aqu√≠ gestionas tus <strong>servicios profesionales</strong>. ¬øQuieres un recorrido o algunos consejos para mejorar tu conversi√≥n?
      </p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnTourServicios" type="button"
          class="px-4 py-2 rounded-lg bg-[#276EF1] text-white font-semibold hover:bg-[#164399] shadow">
          Gu√≠a r√°pida de esta p√°gina
        </button>
        <button id="btnTipsServicios" type="button"
          class="px-4 py-2 rounded-lg bg-white text-[#276EF1] border border-[#276EF1]/40 font-semibold hover:bg-[#E6F2FF] shadow">
          Tips para un servicio exitoso
        </button>
      </div>
    </div>
  </div>

  <!-- Feedback / Alertas -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2 animate-fade-in">
        {% for category, msg in messages %}
          <div class="rounded-xl px-4 py-3 text-center font-semibold shadow
            {% if category == 'success' %} bg-green-50 text-green-800 border-l-4 border-green-400
            {% elif category == 'warning' %} bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400
            {% elif category == 'danger' %} bg-red-50 text-red-700 border-l-4 border-red-400
            {% else %} bg-blue-50 text-blue-700 border-l-4 border-blue-400
            {% endif %}">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Lista de servicios creados -->
  <div id="boxServicios" class="bg-gradient-to-br from-[#e6f3ff] via-[#f7fbff] to-[#e3f1fc] rounded-3xl shadow-xl border border-[#276EF1]/10 p-8 mb-12 animate-fade-in">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-[#276EF1] flex items-center gap-2">
        <i class="fas fa-list-ul"></i> Tus servicios actuales
      </h3>
      <button type="button" class="text-xs font-semibold text-[#276EF1] underline sanibot-help" data-key="lista">
        ¬øQu√© es esto?
      </button>
    </div>

    {% if services %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for s in services %}
        <div class="bg-white rounded-2xl shadow-md p-6 border border-[#276EF1]/10 hover:shadow-2xl transition-shadow relative animate-fade-in-up">
          <!-- Tag de precio -->
          <span class="absolute right-5 top-5 px-3 py-1 rounded-xl bg-[#276EF1]/10 text-[#276EF1] font-bold text-xs shadow-md">
            ${{ "{:,.0f}".format(s.price) }} CLP
          </span>
          <div class="mb-3 flex items-center gap-3">
            <div class="bg-[#276EF1]/10 p-2 rounded-full">
              <i class="fas fa-briefcase-medical text-[#276EF1] text-lg"></i>
            </div>
            <span class="font-bold text-lg text-[#164399]">{{ s.title }}</span>
          </div>
          <p class="text-gray-700 mb-4 min-h-[48px]">{{ s.description|truncate(110) }}</p>
          <div class="flex gap-2">
            <a href="{{ url_for('professional.edit_service', service_id=s.id) }}"
               class="flex items-center gap-1 px-4 py-2 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded-lg font-bold text-xs shadow transition">
              <i class="fas fa-edit"></i> Editar
            </a>
            <form action="{{ url_for('professional.delete_service', service_id=s.id) }}" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este servicio?');">
              {{ delete_form.hidden_tag() }}
              <button type="submit" class="flex items-center gap-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold text-xs shadow transition">
                <i class="fas fa-trash-alt"></i> Eliminar
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="flex flex-col items-center justify-center py-16 text-center">
        <i class="fas fa-heartbeat text-5xl text-[#276EF1] mb-4 animate-pulse"></i>
        <p class="text-xl text-gray-400">No has creado servicios todav√≠a.<br>¬°Agrega tu primer servicio!</p>
      </div>
    {% endif %}
  </div>

  <!-- Formulario de agregar servicio -->
  <div id="boxFormulario" class="bg-white/90 rounded-3xl shadow-2xl border border-[#276EF1]/10 p-10 max-w-2xl mx-auto animate-fade-in-up mb-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-[#276EF1] flex items-center gap-2">
        <i class="fas fa-plus-circle"></i> Crear un nuevo servicio
      </h3>
      <button type="button" class="text-xs font-semibold text-[#276EF1] underline sanibot-help" data-key="form">
        ¬øC√≥mo completo esto?
      </button>
    </div>

    <form method="POST" class="space-y-7">
      {{ form.hidden_tag() }}

      <!-- T√≠tulo -->
      <div>
        {{ form.title.label(class_="block text-[#164399] mb-1 font-semibold") }}
        {{ form.title(
            class_="w-full px-5 py-3 rounded-xl border border-gray-300 bg-[#f8fbfd] text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#276EF1] focus:bg-[#e6eefa] transition text-lg",
            placeholder="Ejemplo: Consulta m√©dica general"
        ) }}
        {% if form.title.errors %}
          <span class="text-red-500 text-xs">{{ form.title.errors[0] }}</span>
        {% endif %}
      </div>

      <!-- Descripci√≥n -->
      <div>
        {{ form.description.label(class_="block text-[#164399] mb-1 font-semibold") }}
        {{ form.description(
            class_="w-full px-5 py-3 rounded-xl border border-gray-300 bg-[#f8fbfd] text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#276EF1] focus:bg-[#e6eefa] transition text-lg",
            rows="5",
            placeholder="Describe tu servicio (m√≠nimo 3 l√≠neas)"
        ) }}
        {% if form.description.errors %}
          <span class="text-red-500 text-xs">{{ form.description.errors[0] }}</span>
        {% endif %}
      </div>

      <!-- Precio -->
      <div>
        {{ form.price.label(class_="block text-[#164399] mb-1 font-semibold") }}
        {{ form.price(
            class_="w-full px-5 py-3 rounded-xl border border-gray-300 bg-[#f8fbfd] text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#276EF1] focus:bg-[#e6eefa] transition text-lg",
            placeholder="Ej: 25000"
        ) }}
        {% if form.price.errors %}
          <span class="text-red-500 text-xs">{{ form.price.errors[0] }}</span>
        {% endif %}
      </div>

      <!-- Bot√≥n -->
      <div>
        <button type="submit"
                class="w-full py-3 bg-[#276EF1] hover:bg-[#164399] text-white rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2">
          <i class="fas fa-save"></i> Guardar servicio
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal SaniBot -->
<style>.sanibot-modal{display:none}</style>
<div id="sanibotServiciosModal" class="sanibot-modal fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white max-w-2xl w-[92%] rounded-2xl shadow-2xl overflow-hidden">
    <div class="flex items-center gap-3 px-6 py-4 border-b">
      <img src="{{ url_for('static', filename='images/sanibot.png') }}" class="w-10 h-10" alt="SaniBot">
      <h3 id="sanibotServiciosTitle" class="text-lg font-bold text-[#0d3b66]">Gu√≠a r√°pida ‚Äî Mis servicios</h3>
    </div>
    <div id="sanibotServiciosBody" class="p-6 space-y-4 text-sm text-gray-700">
      <!-- contenido din√°mico -->
    </div>
    <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2">
      <button id="sanibotServiciosClose" type="button" class="px-4 py-2 rounded-lg border hover:bg-gray-100">Cerrar</button>
      <button id="sanibotServiciosNext" type="button" class="px-4 py-2 rounded-lg bg-[#276EF1] text-white hover:bg-[#164399]">Siguiente</button>
    </div>
  </div>
</div>

<style>
@keyframes fade-in { from { opacity:0; } to { opacity:1; } }
@keyframes fade-in-up { from { opacity:0; transform: translateY(40px);} to { opacity:1; transform: translateY(0);} }
.animate-fade-in    { animation: fade-in 0.8s;}
.animate-fade-in-up { animation: fade-in-up 0.8s;}
.ring-highlight { box-shadow: 0 0 0 4px rgba(39,110,241,.35); border-radius: 1rem; transition: box-shadow .25s ease; }
</style>

<script>
(function(){
  // Anclas para resaltar
  const anchors = {
    lista: () => document.getElementById('boxServicios'),
    form:  () => document.getElementById('boxFormulario'),
  };

  // Paso a paso del tour
  const steps = [
    {
      key: 'lista',
      title: 'Tus servicios actuales',
      html: `
        <p>Aqu√≠ ves todos tus <strong>servicios publicados</strong> y su precio.</p>
        <ul class="list-disc list-inside space-y-1">
          <li><strong>Edita</strong> para mejorar t√≠tulo, descripci√≥n o precio.</li>
          <li><strong>Elimina</strong> servicios duplicados o que ya no ofrezcas.</li>
          <li>Mant√©n textos claros y orientados al paciente (beneficios, alcance, modalidad).</li>
        </ul>`
    },
    {
      key: 'form',
      title: 'Crear un nuevo servicio',
      html: `
        <p>Completa el formulario con la informaci√≥n clave del servicio.</p>
        <ul class="list-disc list-inside space-y-1">
          <li><strong>T√≠tulo:</strong> espec√≠fico y f√°cil de buscar (ej. "Consulta nutricional inicial").</li>
          <li><strong>Descripci√≥n:</strong> incluye qu√© incluye/no incluye, modalidad (online/presencial) y tiempos.</li>
          <li><strong>Precio:</strong> visible y consistente con tu perfil. Evita rangos ambiguos.</li>
        </ul>`
    }
  ];

  const HCLASS = 'ring-highlight';

  // Modal
  const modal  = document.getElementById('sanibotServiciosModal');
  const titleE = document.getElementById('sanibotServiciosTitle');
  const bodyE  = document.getElementById('sanibotServiciosBody');
  const nextB  = document.getElementById('sanibotServiciosNext');
  const closeB = document.getElementById('sanibotServiciosClose');

  let idx = 0;

  function openModal(){
    modal.classList.remove('sanibot-modal');
    document.body.classList.add('overflow-hidden');
  }
  function closeModal(){
    modal.classList.add('sanibot-modal');
    document.body.classList.remove('overflow-hidden');
    clearHighlight();
  }
  function clearHighlight(){
    document.querySelectorAll('.' + HCLASS).forEach(el => el.classList.remove(HCLASS));
  }
  function renderStep(step){
    clearHighlight();
    titleE.textContent = step.title + ' ‚Äî SaniBot';
    bodyE.innerHTML = step.html;
    const target = anchors[step.key]?.();
    if (target) {
      target.classList.add(HCLASS);
      target.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }
  function startTour(){
    idx = 0;
    openModal();
    renderStep(steps[idx]);
    nextB.textContent = 'Siguiente';
  }

  // Botones cabecera
  document.getElementById('btnTourServicios')?.addEventListener('click', startTour);
  document.getElementById('btnTipsServicios')?.addEventListener('click', ()=>{
    openModal();
    titleE.textContent = 'Tips para un servicio exitoso ‚Äî SaniBot';
    bodyE.innerHTML = `
      <ul class="list-disc list-inside space-y-2">
        <li>Usa <strong>palabras clave</strong> que buscan tus pacientes (dolor lumbar, control, teleconsulta).</li>
        <li>Incluye <strong>modalidad</strong>, <strong>duraci√≥n</strong> y <strong>alcance</strong> (qu√© incluye y qu√© no).</li>
        <li>Agrega <strong>precio claro</strong> y evita costos ocultos (mejora la confianza).</li>
        <li>Revisa la <strong>disponibilidad</strong> para no prometer horarios que no tienes.</li>
        <li>Actualiza tus servicios al menos <strong>1 vez al mes</strong> seg√∫n demanda.</li>
      </ul>`;
    nextB.textContent = 'Entendido';
  });

  // Ayudas contextuales
  document.querySelectorAll('.sanibot-help').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-key');
      const step = steps.find(s => s.key === key);
      if (!step) return;
      openModal(); renderStep(step);
      nextB.textContent = 'Entendido';
    });
  });

  // Navegaci√≥n modal
  nextB?.addEventListener('click', ()=>{
    if (nextB.textContent === 'Siguiente'){
      idx++;
      if (idx < steps.length) {
        renderStep(steps[idx]);
        if (idx === steps.length - 1) nextB.textContent = 'Finalizar';
      } else {
        closeModal();
      }
    } else {
      closeModal();
    }
  });
  closeB?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });
})();
</script>
{% endblock %}
