{% extends 'base.html' %}
{% block title %}Solicitudes recibidas{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-b from-[#f5f7fc] to-[#e6eefa] py-6 sm:py-12">
  <div class="max-w-5xl mx-auto px-2 sm:px-4">

    <h2 class="text-2xl sm:text-3xl font-black text-[#276EF1] mb-6 flex items-center gap-3">
      <i class="fas fa-envelope-open-text text-[#FF8800]"></i>
      Solicitudes de clientes
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4">
          {% for category, msg in messages %}
            <div class="rounded-lg p-3 mb-2 text-center font-semibold
                {% if category == 'success' %}bg-green-100 text-green-800
                {% elif category == 'warning' %}bg-yellow-100 text-yellow-700
                {% elif category == 'danger' %}bg-red-100 text-red-700
                {% else %}bg-blue-100 text-blue-700{% endif %}">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if solicitudes %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {% for req in solicitudes %}
      <div class="bg-white rounded-xl shadow-xl border border-[#e6eefa] group transition hover:scale-[1.012]">
        <div class="flex flex-col sm:flex-row items-center gap-4 px-6 py-5">
          <img src="{{ req.client.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
               class="w-14 h-14 rounded-full border-2 border-[#276EF1]/30 object-cover shadow-sm"
               alt="Avatar cliente">
          <div class="flex-1 w-full">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
              <div>
                <span class="block text-lg font-bold text-[#276EF1]">{{ req.client.username }}</span>
                <span class="block font-semibold text-[#164399] text-sm mb-2">{{ req.service.title }}</span>
              </div>
              <span class="text-xs text-gray-400 whitespace-nowrap mt-1 sm:mt-0 flex items-center gap-1">
                <i class="fas fa-calendar-alt"></i> {{ req.date_requested.strftime('%d-%m-%Y %H:%M') }}
              </span>
            </div>
            <div class="mt-2 text-gray-600 text-sm max-w-[95vw] break-all">
              <i class="fas fa-comment-dots mr-1 text-[#FF8800]"></i>
              {{ req.message[:70] }}{% if req.message|length > 70 %}...{% endif %}
            </div>
            <div class="flex flex-wrap items-center gap-2 mt-3">
              {% if req.status == 'pending' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold text-xs animate-pulse">
                  <i class="fas fa-hourglass-half"></i> Pendiente
                </span>
              {% elif req.status == 'accepted' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold text-xs">
                  <i class="fas fa-check-circle"></i> Aceptada
                </span>
              {% elif req.status == 'rejected' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-700 font-bold text-xs">
                  <i class="fas fa-times-circle"></i> Rechazada
                </span>
              {% elif req.status == 'completed' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-800 font-bold text-xs">
                  <i class="fas fa-flag-checkered"></i> Completada
                </span>
              {% endif %}
              <div class="flex gap-2 mt-2 sm:mt-0 ml-auto">
                <a href="{{ url_for('professional.respond_request', request_id=req.id) }}"
                   class="inline-flex items-center gap-1 px-3 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded-lg font-bold text-xs shadow transition"
                   title="Ver o responder solicitud">
                  <i class="fas fa-reply"></i> Ver/Responder
                </a>
                {% if req.status == 'accepted' %}
                  <button type="button"
                          onclick="openModal('modal-completar-{{ req.id }}')"
                          class="inline-block px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-xs shadow transition">
                    <i class="fas fa-flag-checkered"></i> Completar
                  </button>
                  <!-- Modal de confirmación -->
                  <div id="modal-completar-{{ req.id }}"
                       class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden"
                       tabindex="-1" aria-modal="true" role="dialog">
                    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full text-center relative animate-fade-in border border-[#276EF1]/20">
                      <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700" onclick="closeModal('modal-completar-{{ req.id }}')" aria-label="Cerrar">
                        <i class="fas fa-times text-xl"></i>
                      </button>
                      <h3 class="text-2xl font-bold text-[#276EF1] mb-4 flex items-center gap-2">
                        <i class="fas fa-exclamation-circle text-[#FF8800]"></i>
                        Confirmar finalización del servicio
                      </h3>
                      <ul class="text-left text-gray-600 mt-2 mb-4 list-disc list-inside text-sm">
                        <li>El trabajo fue realizado y entregado al cliente.</li>
                        <li>No podrás modificar el estado después de confirmar.</li>
                        <li>El cliente podrá dejar una evaluación sobre tu servicio.</li>
                      </ul>
                      <form method="POST" action="{{ url_for('professional.complete_request', request_id=req.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="flex gap-3 justify-center mt-6">
                          <button type="submit"
                                  class="px-6 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded font-bold shadow transition">
                            Sí, finalizar
                          </button>
                          <button type="button"
                                  onclick="closeModal('modal-completar-{{ req.id }}')"
                                  class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-[#276EF1] rounded font-bold shadow transition">
                            Cancelar
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="bg-white text-gray-400 rounded-lg p-10 mt-10 text-center shadow-md border border-[#276EF1]/10">
        <i class="fas fa-info-circle text-4xl mb-3 text-[#FF8800]"></i><br>
        <span class="block text-xl font-semibold mb-2 text-[#164399]">No tienes solicitudes por ahora.</span>
        <span class="text-sm text-[#276EF1]">Cuando un cliente te solicite un servicio, aparecerá aquí.</span>
      </div>
    {% endif %}
  </div>
</section>

<script>
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
}
function closeModal(id) {
  document.getElementById(id
