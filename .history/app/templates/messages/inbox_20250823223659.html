{% extends 'base.html' %}
{% block title %}Mensajes – IndepSalud{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-12 px-2 animate-fade-in">

  <!-- Header -->
  <div class="flex items-center gap-3 mb-6">
    <div class="bg-[#276EF1]/10 rounded-full p-3 shadow">
      <i class="fas fa-inbox text-2xl text-[#276EF1]"></i>
    </div>
    <h2 class="text-4xl font-black text-[#276EF1] tracking-tight">Bandeja de Mensajes</h2>
  </div>

  <!-- SaniBot -->
  <div class="bg-white rounded-2xl border border-indigo-100 shadow p-5 mb-6 flex items-start gap-4">
    <img src="{{ url_for('static', filename='images/sanibot.png') }}" alt="SaniBot" class="w-12 h-12 rounded-full shadow">
    <div class="flex-1">
      <h3 class="text-lg font-bold text-[#0d3b66]">Hola, soy SaniBot 🤖</h3>
      <p class="text-gray-600 mt-1">
        Aquí gestionas tus <strong>conversaciones</strong>. ¿Quieres una guía rápida o tips para responder mejor y mantener tu bandeja al día?
      </p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnTourInbox" type="button"
                class="px-4 py-2 rounded-lg bg-[#276EF1] text-white font-semibold hover:bg-[#1E5BB8] shadow">
          Guía rápida
        </button>
        <button id="btnTipsInbox" type="button"
                class="px-4 py-2 rounded-lg bg-white text-[#276EF1] border border-[#276EF1]/40 font-semibold hover:bg-[#E6F2FF] shadow">
          Tips de mensajería segura
        </button>
      </div>
    </div>
  </div>

  <!-- Filtros locales -->
  <div class="bg-white border border-[#276EF1]/10 rounded-2xl shadow p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">Buscar</label>
        <input id="fSearch" type="text" class="w-full px-3 py-2 border rounded-lg"
               placeholder="Nombre, correo o servicio">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Ordenar por</label>
        <select id="fSort" class="w-full px-3 py-2 border rounded-lg">
          <option value="date_desc">Más recientes</option>
          <option value="date_asc">Más antiguas</option>
          <option value="name_asc">Nombre A→Z</option>
          <option value="name_desc">Nombre Z→A</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <input id="fUnread" type="checkbox" class="h-4 w-4 accent-[#276EF1]">
        <label for="fUnread" class="text-sm text-gray-700">Solo no leídos</label>
      </div>
      <div class="flex gap-2">
        <button id="btnApply" class="px-4 py-2 bg-[#276EF1] text-white rounded-lg font-semibold hover:bg-[#1E5BB8] w-full">Aplicar</button>
        <button id="btnClear" class="px-4 py-2 bg-white border rounded-lg font-semibold w-full">Limpiar</button>
      </div>
    </div>
    <div class="mt-2 text-xs text-gray-500" id="inboxCount"></div>
  </div>

  {% if grouped_convos and grouped_convos|length > 0 %}
  <!-- Lista de conversaciones -->
  <div id="inboxList" class="bg-gradient-to-br from-[#e6f3ff] via-[#f7fbff] to-[#e3f1fc] rounded-3xl shadow-2xl border border-[#276EF1]/10 overflow-hidden divide-y divide-gray-100">
    {% for convo in grouped_convos %}
      {# Datos para filtros: data-* #}
      <a href="{{ url_for('messages.chat', other_id=convo['other'].id, service_id=convo['service'].id) }}"
         class="convo-item flex items-center px-8 py-7 group gap-6 transition-all duration-150 relative hover:bg-[#276EF1]/5 focus:bg-[#276EF1]/10 outline-none"
         tabindex="0"
         data-name="{{ (convo['other'].full_name or convo['other'].username)|lower }}"
         data-service="{{ convo['service'].title|lower }}"
         data-date="{{ convo['last_msg'].timestamp.isoformat() if convo['last_msg'] and convo['last_msg'].timestamp else '' }}"
         data-unread="{{ 1 if convo.get('unread_count', 0) > 0 else 0 }}">
        <!-- Badge "Nuevo" -->
        {% if convo.get('unread_count', 0) > 0 %}
        <span class="absolute left-0 top-1/2 -translate-y-1/2 bg-[#FF8800] text-white text-xs font-bold px-3 py-1 rounded-full shadow animate-bounce z-10 ml-1">
          {{ convo.get('unread_count', 0) > 9 and '9+' or convo.get('unread_count', 0) }} Nuevo
        </span>
        {% endif %}

        <!-- Avatar -->
        <div class="relative">
          <img src="{{ convo['other'].profile_image_url or url_for('static', filename='images/placeholder.png') }}"
               alt="Avatar de {{ convo['other'].username }}"
               class="h-16 w-16 rounded-full border-4 border-[#276EF1]/30 object-cover shadow group-hover:scale-105 transition duration-200 bg-[#e6f3ff]" />
          {% if convo['other'].is_online %}
            <span class="absolute bottom-1 right-1 w-4 h-4 rounded-full bg-green-400 border-2 border-white shadow" title="En línea"></span>
          {% endif %}
        </div>

        <!-- Info -->
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-[#164399] text-lg truncate flex items-center gap-2">
              {{ convo['other'].full_name or convo['other'].username }}
              {% if convo['other'].is_verified %}
                <i class="fas fa-certificate text-[#276EF1]" title="Usuario verificado"></i>
              {% endif %}
            </span>
            <span class="text-xs text-gray-400 whitespace-nowrap font-semibold">
              {{ convo['last_msg'].timestamp.strftime('%d-%m-%Y %H:%M') }}
            </span>
          </div>
          <div class="flex items-center gap-2 text-gray-700 text-sm truncate">
            <span class="inline-block px-3 py-1 bg-[#276EF1]/10 text-[#276EF1] rounded-full text-xs font-semibold">
              {{ convo['service'].title }}
            </span>
            {% if convo['last_msg'].sender_id == current_user.id %}
              <span class="text-gray-400 font-semibold">Tú:</span>
            {% endif %}
            <span class="{% if convo.get('unread_count', 0) > 0 %}font-bold text-[#276EF1]{% else %}text-gray-600{% endif %}">
              {{ convo['last_msg'].body[:64] }}{% if convo['last_msg'].body|length > 64 %}...{% endif %}
            </span>
          </div>
        </div>

        <!-- Flecha -->
        <i class="fas fa-chevron-right text-[#276EF1] opacity-0 group-hover:opacity-100 transition text-xl"></i>
      </a>
    {% endfor %}
  </div>
  {% else %}
  <!-- Empty state -->
  <div class="bg-white rounded-3xl shadow-xl p-14 text-center text-gray-400 mt-10 animate-fade-in-up border border-[#276EF1]/10">
    <i class="fas fa-envelope-open-text text-6xl mb-5 text-[#276EF1]"></i>
    <p class="text-2xl font-black mb-2 text-[#164399]">¡Aún no tienes mensajes!</p>
    <p class="text-lg text-[#276EF1] mb-8">
      Chatea con profesionales o clientes desde sus perfiles.<br>
      Las conversaciones aparecerán aquí.
    </p>
    <a href="{{ url_for('main.search') }}"
       class="inline-block mt-4 px-10 py-4 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded-full font-bold shadow-lg transition text-lg">
      <i class="fas fa-user-friends mr-2"></i> Buscar profesionales
    </a>
  </div>
  {% endif %}
</div>

<!-- Modal SaniBot -->
<style>.sanibot-modal{display:none}</style>
<div id="sanibotInboxModal" class="sanibot-modal fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white max-w-2xl w-[92%] rounded-2xl shadow-2xl overflow-hidden">
    <div class="flex items-center gap-3 px-6 py-4 border-b">
      <img src="{{ url_for('static', filename='images/sanibot.png') }}" class="w-10 h-10" alt="SaniBot">
      <h3 id="sanibotInboxTitle" class="text-lg font-bold text-[#0d3b66]">Guía — Bandeja de Mensajes</h3>
    </div>
    <div id="sanibotInboxBody" class="p-6 space-y-4 text-sm text-gray-700"></div>
    <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2">
      <button id="sanibotInboxClose" type="button" class="px-4 py-2 rounded-lg border hover:bg-gray-100">Cerrar</button>
      <button id="sanibotInboxNext" type="button" class="px-4 py-2 rounded-lg bg-[#276EF1] text-white hover:bg-[#1E5BB8]">Siguiente</button>
    </div>
  </div>
</div>

<style>
  @keyframes fade-in {0%{opacity:0;}100%{opacity:1;}}
  .animate-fade-in {animation: fade-in 1.2s cubic-bezier(.6,0,.4,1);}
  @keyframes fade-in-up {0%{opacity:0;transform:translateY(40px);}100%{opacity:1;transform:none;}}
  .animate-fade-in-up {animation: fade-in-up 1.1s cubic-bezier(.6,0,.4,1) forwards;}
  @keyframes bounce {0%,100%{transform:translateY(0);}50%{transform:translateY(-7px);}}
  .animate-bounce { animation: bounce 1.1s cubic-bezier(.53,.21,.29,1) 2; }
  @media (max-width: 750px) {
    .h-16, .w-16 { height: 46px !important; width: 46px !important; }
    .px-8 { padding-left: 1rem !important; padding-right: 1rem !important; }
    .py-7 { padding-top: 1.1rem !important; padding-bottom: 1.1rem !important; }
    .text-lg { font-size: 1rem !important; }
    .rounded-3xl { border-radius: 1.2rem !important; }
  }
  .ring-highlight { box-shadow: 0 0 0 4px rgba(39,110,241,.35); border-radius: 1rem; transition: box-shadow .25s ease; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const safe = fn => { try { fn && fn(); } catch(e){ console.warn('[inbox]', e); } };

  /* ====== Filtros locales ====== */
  safe(() => {
    const list = $('#inboxList');
    if (!list) return;

    const fSearch = $('#fSearch');
    const fSort   = $('#fSort');
    const fUnread = $('#fUnread');
    const btnApply= $('#btnApply');
    const btnClear= $('#btnClear');
    const info    = $('#inboxCount');
    let items = $$('.convo-item');

    function applyFilters(){
      let view = [...items];
      const q = (fSearch?.value || '').trim().toLowerCase();
      const onlyUnread = !!(fUnread?.checked);
      const sort = fSort?.value || 'date_desc';

      // Filtro texto
      if (q) {
        view = view.filter(a => {
          const name = (a.dataset.name || '');
          const srv  = (a.dataset.service || '');
          return name.includes(q) || srv.includes(q);
        });
      }

      // Solo no leídos
      if (onlyUnread) {
        view = view.filter(a => Number(a.dataset.unread) === 1);
      }

      // Orden
      if (sort === 'date_desc') {
        view.sort((a,b)=> new Date(b.dataset.date||0) - new Date(a.dataset.date||0));
      } else if (sort === 'date_asc') {
        view.sort((a,b)=> new Date(a.dataset.date||0) - new Date(b.dataset.date||0));
      } else if (sort === 'name_asc') {
        view.sort((a,b)=> (a.dataset.name||'').localeCompare(b.dataset.name||''));
      } else if (sort === 'name_desc') {
        view.sort((a,b)=> (b.dataset.name||'').localeCompare(a.dataset.name||''));
      }

      // Render
      list.innerHTML = '';
      view.forEach(a => list.appendChild(a));

      // Info
      const unreadAll = items.filter(a => Number(a.dataset.unread) === 1).length;
      const unreadShown = view.filter(a => Number(a.dataset.unread) === 1).length;
      if (info) {
        info.textContent = `Mostrando ${view.length} de ${items.length} conversaciones — No leídos: ${unreadShown}/${unreadAll}`;
      }
    }

    btnApply?.addEventListener('click', (e)=>{ e.preventDefault(); applyFilters(); });
    btnClear?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (fSearch) fSearch.value = '';
      if (fUnread) fUnread.checked = false;
      if (fSort)   fSort.value = 'date_desc';
      applyFilters();
    });

    // Enter en búsqueda
    fSearch?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); applyFilters(); }});

    // Estado inicial
    applyFilters();

    // Navegación con teclado (↑↓, Enter)
    document.addEventListener('keydown', (e)=>{
      const focusable = $$('.convo-item');
      if (!focusable.length) return;
      const idx = focusable.findIndex(el => el === document.activeElement);
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = focusable[Math.min((idx<0? -1: idx)+1, focusable.length-1)];
        next?.focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = focusable[Math.max((idx<0? 1: idx)-1, 0)];
        prev?.focus();
      } else if (e.key === 'Enter' && idx >= 0) {
        e.preventDefault();
        focusable[idx].click();
      }
    });
  });

  /* ====== SaniBot (tour + tips) ====== */
  const modal  = $('#sanibotInboxModal');
  const titleE = $('#sanibotInboxTitle');
  const bodyE  = $('#sanibotInboxBody');
  const nextB  = $('#sanibotInboxNext');
  const closeB = $('#sanibotInboxClose');
  const HCLASS = 'ring-highlight';

  const anchors = {
    filtros: () => document.querySelector('.bg.white, .bg-white.border') || document.querySelector('.bg-white'),
    lista:   () => $('#inboxList'),
    header:  () => document.querySelector('h2'),
  };
  const steps = [
    { key:'header',  title:'Bandeja de Mensajes', html:`<p>Desde aquí accedes a todas tus conversaciones con pacientes y profesionales.</p>` },
    { key:'filtros', title:'Filtra y ordena',      html:`<p>Busca por nombre o servicio, ordena por fecha o nombre y muestra solo no leídos.</p>` },
    { key:'lista',   title:'Conversaciones',       html:`<p>Haz click para abrir un chat. Las etiquetas “Nuevo” indican mensajes no leídos.</p>` },
  ];

  let idx = 0;
  function openModal(){ if(!modal) return; modal.classList.remove('sanibot-modal'); document.body.classList.add('overflow-hidden'); }
  function closeModal(){ if(!modal) return; modal.classList.add('sanibot-modal'); document.body.classList.remove('overflow-hidden'); clearHL(); }
  function clearHL(){ document.querySelectorAll('.'+HCLASS).forEach(el=>el.classList.remove(HCLASS)); }
  function renderStep(step){
    clearHL();
    if (titleE) titleE.textContent = step.title + ' — SaniBot';
    if (bodyE)  bodyE.innerHTML = step.html;
    const target = anchors[step.key]?.();
    if (target){ target.classList.add(HCLASS); target.scrollIntoView({behavior:'smooth', block:'center'}); }
  }
  function startTour(){ idx=0; openModal(); renderStep(steps[idx]); nextB && (nextB.textContent='Siguiente'); }

  $('#btnTourInbox')?.addEventListener('click', startTour);
  $('#btnTipsInbox')?.addEventListener('click', ()=>{
    openModal();
    if (titleE) titleE.textContent = 'Tips de mensajería segura — SaniBot';
    if (bodyE)  bodyE.innerHTML = `
      <ul class="list-disc list-inside space-y-2">
        <li>Evita compartir datos sensibles por chat (RUT completo, claves, etc.).</li>
        <li>Responde dentro de las primeras 2 horas para mejorar conversión.</li>
        <li>Usa mensajes cortos y claros; confirma hora y servicio en el primer intercambio.</li>
        <li>Si un caso no aplica a tu especialidad, deriva y cierra amablemente.</li>
        <li>Marca como resuelto desde el flujo del servicio para habilitar evaluación.</li>
      </ul>`;
    nextB && (nextB.textContent = 'Entendido');
  });

  nextB?.addEventListener('click', ()=>{
    if (nextB.textContent === 'Siguiente'){
      idx++; (idx < steps.length) ? renderStep(steps[idx]) : closeModal();
      if (idx === steps.length - 1) nextB.textContent = 'Finalizar';
    } else { closeModal(); }
  });
  closeB?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });
});
</script>

{% endblock %}
