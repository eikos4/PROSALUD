{% extends 'base.html' %}
{% block title %}Mensajes – PROSALUD{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-12 px-2 animate-fade-in">
  <div class="flex items-center gap-3 mb-10">
    <div class="bg-[#276EF1]/10 rounded-full p-3 shadow">
      <i class="fas fa-inbox text-2xl text-[#276EF1]"></i>
    </div>
    <h2 class="text-4xl font-black text-[#276EF1] tracking-tight">Bandeja de Mensajes</h2>
  </div>

  {% if grouped_convos and grouped_convos|length > 0 %}
    <div class="bg-gradient-to-br from-[#e6f3ff] via-[#f7fbff] to-[#e3f1fc] rounded-3xl shadow-2xl border border-[#276EF1]/10 overflow-hidden divide-y divide-gray-100">
      {% for convo in grouped_convos %}
        <a href="{{ url_for('messages.chat', other_id=convo['other'].id, service_id=convo['service'].id) }}"
           class="flex items-center px-8 py-7 group gap-6 transition-all duration-150 relative hover:bg-[#276EF1]/5 focus:bg-[#276EF1]/10 outline-none"
           tabindex="0">
          <!-- Badge "Nuevo" si hay mensajes no leídos -->
          {% if convo.get('unread_count', 0) > 0 %}
            <span class="absolute left-0 top-1/2 -translate-y-1/2 bg-[#FF8800] text-white text-xs font-bold px-3 py-1 rounded-full shadow animate-bounce z-10 ml-1">
              {{ convo.get('unread_count', 0) > 9 and '9+' or convo.get('unread_count', 0) }} Nuevo
            </span>
          {% endif %}
          <!-- Avatar -->
          <div class="relative">
            <img src="{{ convo['other'].profile_image_url or url_for('static', filename='images/placeholder.png') }}"
                 alt="Avatar de {{ convo['other'].username }}"
                 class="h-16 w-16 rounded-full border-4 border-[#276EF1]/30 object-cover shadow group-hover:scale-105 transition duration-200 bg-[#e6f3ff]" />
            <!-- Online badge opcional -->
            {% if convo['other'].is_online %}
              <span class="absolute bottom-1 right-1 w-4 h-4 rounded-full bg-green-400 border-2 border-white shadow"></span>
            {% endif %}
          </div>
          <!-- Info de la conversación -->
          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-center mb-1">
              <span class="font-bold text-[#164399] text-lg truncate flex items-center gap-2">
                {{ convo['other'].full_name or convo['other'].username }}
                {% if convo['other'].is_verified %}
                  <i class="fas fa-certificate text-[#276EF1]" title="Usuario verificado"></i>
                {% endif %}
              </span>
              <span class="text-xs text-gray-400 whitespace-nowrap font-semibold">
                {{ convo['last_msg'].timestamp.strftime('%d-%m-%Y %H:%M') }}
              </span>
            </div>
            <div class="flex items-center gap-2 text-gray-700 text-sm truncate">
              <span class="inline-block px-3 py-1 bg-[#276EF1]/10 text-[#276EF1] rounded-full text-xs font-semibold">{{ convo['service'].title }}</span>
              {% if convo['last_msg'].sender_id == current_user.id %}
                <span class="text-gray-400 font-semibold">Tú:</span>
              {% endif %}
              <span class="{% if convo.get('unread_count', 0) > 0 %}font-bold text-[#276EF1]{% else %}text-gray-600{% endif %}">
                {{ convo['last_msg'].body[:64] }}{% if convo['last_msg'].body|length > 64 %}...{% endif %}
              </span>
            </div>
          </div>
          <!-- Icono -->
          <i class="fas fa-chevron-right text-[#276EF1] opacity-0 group-hover:opacity-100 transition text-xl"></i>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white rounded-3xl shadow-xl p-14 text-center text-gray-400 mt-10 animate-fade-in-up border border-[#276EF1]/10">
      <i class="fas fa-envelope-open-text text-6xl mb-5 text-[#276EF1]"></i>
      <p class="text-2xl font-black mb-2 text-[#164399]">¡Aún no tienes mensajes!</p>
      <p class="text-lg text-[#276EF1] mb-8">
        Chatea con profesionales o clientes desde sus perfiles.<br>
        Las conversaciones aparecerán aquí.
      </p>
      <a href="{{ url_for('main.search') }}"
         class="inline-block mt-4 px-10 py-4 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded-full font-bold shadow-lg transition text-lg">
        <i class="fas fa-user-friends mr-2"></i> Buscar profesionales
      </a>
    </div>
  {% endif %}
</div>

<style>
  @keyframes fade-in {0%{opacity:0;}100%{opacity:1;}}
  .animate-fade-in {animation: fade-in 1.2s cubic-bezier(.6,0,.4,1);}
  @keyframes fade-in-up {0%{opacity:0;transform:translateY(40px);}100%{opacity:1;transform:none;}}
  .animate-fade-in-up {animation: fade-in-up 1.1s cubic-bezier(.6,0,.4,1) forwards;}
  @keyframes bounce {
    0%, 100% { transform: translateY(0);}
    50% { transform: translateY(-7px);}
  }
  .animate-bounce { animation: bounce 1.1s cubic-bezier(.53,.21,.29,1) 2; }
  @media (max-width: 750px) {
    .h-16, .w-16 { height: 46px !important; width: 46px !important; }
    .px-8 { padding-left: 1rem !important; padding-right: 1rem !important; }
    .py-7 { padding-top: 1.1rem !important; padding-bottom: 1.1rem !important; }
    .text-lg { font-size: 1rem !important; }
    .rounded-3xl { border-radius: 1.2rem !important; }
  }
</style>
{% endblock %}
