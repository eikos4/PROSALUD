{% extends 'base.html' %}
{% block title %}Chat con {{ other_user.username }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
  <h2 class="text-2xl font-bold mb-6 text-[#276EF1] flex items-center gap-2">
    <i class="fas fa-comments"></i>
    Chat con {{ other_user.username }}
  </h2>
  <div id="chat-box" class="bg-white rounded-lg p-5 shadow mb-6 min-h-[300px] max-h-[420px] overflow-y-auto">
    {% if convo|length == 0 %}
      <div class="text-gray-400 text-center my-8">
        <i class="fas fa-comment-dots text-4xl mb-2"></i>
        <p>No hay mensajes aún. ¡Comienza la conversación!</p>
      </div>
    {% endif %}
    {% for msg in convo %}
      <div class="mb-2 flex {% if msg.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %}">
        {% if msg.sender_id != current_user.id %}
          <img src="{{ other_user.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
               alt="{{ other_user.username }}"
               class="w-7 h-7 rounded-full border-2 border-[#FF8800]/30 mr-2 mt-1 hidden sm:inline-block">
        {% endif %}
        <div class="inline-block px-5 py-3 rounded-2xl max-w-xs shadow
          {% if msg.sender_id == current_user.id %}
            bg-gradient-to-br from-[#276EF1] to-[#4bb3fd] text-white
          {% else %}
            bg-gray-200 text-gray-800
          {% endif %}">
          <span class="block font-semibold text-xs mb-1 opacity-70">
            {% if msg.sender_id == current_user.id %}Tú{% else %}{{ other_user.username }}{% endif %}
          </span>
          <span class="block">{{ msg.body }}</span>
          <span class="block text-[10px] text-gray-400 mt-1 text-right">{{ msg.timestamp.strftime('%d-%m-%Y %H:%M') }}</span>
        </div>
      </div>
    {% endfor %}
  </div>
  <form method="POST" class="flex gap-2">
    {{ form.hidden_tag() }}
    {{ form.body(class_="flex-1 px-4 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-[#276EF1] bg-white text-gray-900", rows="2", placeholder="Escribe un mensaje...") }}
    <button type="submit" class="px-5 py-2 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded font-semibold flex items-center gap-2">
      <i class="fas fa-paper-plane"></i> Enviar
    </button>
  </form>
</div>
<script>
  // Auto scroll al último mensaje
  window.onload = function() {
    var chatBox = document.getElementById('chat-box');
    if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
  }
</script>
{% endblock %}
