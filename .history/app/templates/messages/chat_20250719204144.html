{% extends 'base.html' %}
{% block title %}Chat con {{ other_user.username }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
  <!-- Header de chat -->
  <div class="flex items-center gap-3 mb-8 p-4 bg-gradient-to-r from-[#e6f3ff] to-[#f7fbff] rounded-2xl shadow">
    <img src="{{ other_user.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
         alt="{{ other_user.username }}" class="w-12 h-12 rounded-full border-2 border-[#276EF1]/40 object-cover shadow" />
    <div>
      <h2 class="text-2xl font-bold text-[#276EF1] flex items-center gap-2">
        <i class="fas fa-comments"></i> Chat con {{ other_user.full_name or other_user.username }}
      </h2>
      {% if other_user.is_online %}
        <span class="inline-flex items-center gap-1 text-xs font-bold text-green-500"><i class="fas fa-circle"></i> En línea</span>
      {% endif %}
    </div>
  </div>

  <!-- Chat box -->
  <div id="chat-box" class="bg-white/90 rounded-2xl p-6 shadow-lg mb-6 min-h-[320px] max-h-[420px] overflow-y-auto border border-[#276EF1]/10 transition">
    {% if convo|length == 0 %}
      <div class="text-gray-400 text-center my-10">
        <i class="fas fa-comment-dots text-5xl mb-2"></i>
        <p class="mt-3 text-lg font-semibold">No hay mensajes aún.<br>¡Comienza la conversación!</p>
      </div>
    {% endif %}
    {% for msg in convo %}
      <div class="mb-3 flex {% if msg.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %} animate-chat-fade">
        {% if msg.sender_id != current_user.id %}
          <div class="flex items-end gap-2">
            <img src="{{ other_user.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
                 alt="{{ other_user.username }}"
                 class="w-8 h-8 rounded-full border-2 border-[#FF8800]/30 shadow-sm hidden sm:block">
            <div>
              <span class="block text-xs font-bold text-[#276EF1] mb-1 ml-1">{{ other_user.full_name or other_user.username }}</span>
              <div class="relative group">
                <div class="inline-block px-5 py-3 rounded-2xl max-w-xs bg-[#f7fbff] text-gray-800 shadow border border-[#276EF1]/10 transition-all duration-150 group-hover:shadow-xl">
                  {{ msg.body }}
                </div>
                <span class="absolute -bottom-5 left-1 text-[10px] text-gray-400 opacity-0 group-hover:opacity-100 transition pointer-events-none">{{ msg.timestamp.strftime('%d-%m-%Y %H:%M') }}</span>
              </div>
            </div>
          </div>
        {% else %}
          <div class="flex flex-col items-end gap-1">
            <div class="relative group">
              <div class="inline-block px-5 py-3 rounded-2xl max-w-xs bg-gradient-to-br from-[#276EF1] to-[#4bb3fd] text-white shadow-md border border-[#276EF1]/20 transition-all duration-150 group-hover:shadow-xl">
                {{ msg.body }}
              </div>
              <span class="absolute -bottom-5 right-0 text-[10px] text-gray-400 opacity-0 group-hover:opacity-100 transition pointer-events-none">{{ msg.timestamp.strftime('%d-%m-%Y %H:%M') }}</span>
            </div>
            <span class="block text-xs font-bold text-[#4bb3fd] mt-1 mr-2">Tú</span>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Formulario de mensaje -->
  <form method="POST" class="flex gap-3 items-center bg-white/80 rounded-2xl shadow px-4 py-3 border border-[#276EF1]/10">
    {{ form.hidden_tag() }}
    {{ form.body(class_="flex-1 px-4 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-[#276EF1] bg-[#f7fbff] text-gray-900 transition text-base", rows="2", placeholder="Escribe un mensaje...") }}
    <button type="submit" class="px-6 py-2 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded-xl font-bold flex items-center gap-2 shadow transition">
      <i class="fas fa-paper-plane"></i> Enviar
    </button>
  </form>
</div>

<style>
  @keyframes chat-fade {0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:none;}}
  .animate-chat-fade {animation: chat-fade 0.4s;}
  #chat-box::-webkit-scrollbar { width: 6px; background: #f7fbff;}
  #chat-box::-webkit-scrollbar-thumb { background: #e6f3ff; border-radius: 12px;}
  @media (max-width: 640px) {
    .max-w-xs { max-width: 92vw !important; }
    .w-8, .h-8 { width: 32px !important; height: 32px !important; }
    .w-12, .h-12 { width: 44px !important; height: 44px !important; }
    .text-2xl { font-size: 1.1rem !important; }
    .px-6 { padding-left: 0.7rem !important; padding-right: 0.7rem !important; }
  }
</style>

<script>
  // Auto scroll al último mensaje SIEMPRE, también al enviar/recibir (ajax-ready)
  function scrollToBottom(){
    var chatBox = document.getElementById('chat-box');
    if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
  }
  window.onload = scrollToBottom;
</script>
{% endblock %}
