{% extends 'base.html' %}
{% block title %}Detalle de solicitud{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto py-10 px-2 sm:px-4 animate-fade-in">

  <h2 class="text-3xl font-black text-[#276EF1] mb-7 flex items-center gap-2">
    <i class="fas fa-handshake"></i> Detalle de Solicitud
  </h2>

  <!-- DATOS PRINCIPALES -->
  <div class="bg-white rounded-xl shadow-lg p-7 mb-8 flex flex-col gap-4 border border-[#276EF1]/10">
    <div class="flex flex-col sm:flex-row gap-5 sm:gap-12 items-center">
      <div class="flex flex-col items-center">
        <img src="{{ req.service.professional.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
             class="w-14 h-14 rounded-full border-2 border-[#276EF1]/30 object-cover mb-2" alt="avatar">
        <span class="text-[#164399] font-semibold text-center">{{ req.service.professional.full_name or req.service.professional.username }}</span>
        <span class="block text-xs text-gray-400">Profesional</span>
      </div>
      <div class="flex-1 w-full">
        <div>
          <span class="font-semibold text-[#164399]">Servicio:</span>
          <span class="text-gray-700 font-semibold">{{ req.service.title }}</span>
          <div class="text-gray-600 text-sm">{{ req.service.description }}</div>
        </div>
        <div class="mt-2">
          <span class="font-semibold text-[#164399]">Estado:</span>
          {% if req.status == 'pending' %}
            <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full font-bold text-xs">Pendiente</span>
          {% elif req.status == 'accepted' %}
            <span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full font-bold text-xs">Aceptada</span>
          {% elif req.status == 'rejected' %}
            <span class="inline-block px-3 py-1 bg-red-100 text-red-700 rounded-full font-bold text-xs">Rechazada</span>
          {% elif req.status == 'completed' %}
            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-bold text-xs">Completada</span>
          {% endif %}
        </div>
        <div class="mt-2">
          <span class="font-semibold text-[#164399]">Fecha de solicitud:</span>
          <span class="text-gray-700">{{ req.date_requested.strftime('%d-%m-%Y %H:%M') }}</span>
        </div>
      </div>
    </div>

    <!-- OPCIÓN DE DEJAR RESEÑA -->
    {% if req.status == 'completed' and not evaluation_exists %}
      <div class="mt-4 text-center">
        <a href="{{ url_for('client.evaluate', request_id=req.id) }}"
           class="inline-block px-7 py-3 bg-gradient-to-r from-[#FF8800] to-[#276EF1] hover:from-[#CC7700] hover:to-[#1E5BB8] text-white rounded-full font-extrabold text-lg shadow transition">
          <i class="fas fa-star mr-2"></i> Dejar reseña al profesional
        </a>
      </div>
    {% elif req.status == 'completed' and evaluation_exists %}
      <div class="mt-4 text-center">
        <span class="inline-block px-4 py-2 bg-green-100 text-green-700 rounded font-semibold shadow">
          Ya enviaste una reseña para este servicio.
        </span>
      </div>
    {% endif %}
  </div>

  <!-- CHAT DIRECTO -->
  <div class="bg-white rounded-xl shadow-md p-6 border border-[#FF8800]/10 mb-8">
    <h3 class="text-xl font-black text-[#FF8800] mb-4 flex items-center gap-2">
      <i class="fas fa-comments"></i> Chat directo con <span class="ml-1">{{ other_user.full_name or other_user.username }}</span>
    </h3>
    <div id="chat-box" class="bg-[#f5f7fc] rounded-lg p-4 shadow-inner mb-6 min-h-[230px] max-h-[370px] overflow-y-auto">
      {% if convo|length == 0 %}
        <div class="text-gray-400 text-center my-10">
          <i class="fas fa-comment-dots text-3xl mb-2"></i>
          <p>No hay mensajes aún. ¡Comienza la conversación!</p>
        </div>
      {% endif %}
      {% for msg in convo %}
        <div class="mb-2 flex {% if msg.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %}">
          {% if msg.sender_id != current_user.id %}
            <img src="{{ other_user.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
                 alt="{{ other_user.username }}"
                 class="w-7 h-7 rounded-full border-2 border-[#FF8800]/30 mr-2 mt-1 hidden sm:inline-block">
          {% endif %}
          <div class="inline-block px-5 py-3 rounded-2xl max-w-xs shadow
            {% if msg.sender_id == current_user.id %}
              bg-gradient-to-br from-[#276EF1] to-[#4bb3fd] text-white
            {% else %}
              bg-gray-200 text-gray-800
            {% endif %}">
            <span class="block font-semibold text-xs mb-1 opacity-70">
              {% if msg.sender_id == current_user.id %}Tú{% else %}{{ other_user.full_name or other_user.username }}{% endif %}
            </span>
            <span class="block break-words">{{ msg.body }}</span>
            <span class="block text-[10px] text-gray-400 mt-1 text-right">{{ msg.timestamp.strftime('%d-%m-%Y %H:%M') }}</span>
          </div>
        </div>
      {% endfor %}
    </div>
    <form method="POST" class="flex gap-2">
      {{ form.hidden_tag() }}
      {{ form.body(class_="flex-1 px-4 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-[#FF8800] bg-white text-gray-900", rows="2", placeholder="Escribe un mensaje...") }}
      <button type="submit" class="px-6 py-2 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded font-bold flex items-center gap-2">
        <i class="fas fa-paper-plane"></i> Enviar
      </button>
    </form>
  </div>

  <div class="mt-6">
    <a href="{{ url_for('client.my_requests') }}"
       class="inline-block px-6 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded-lg font-semibold transition">
      <i class="fas fa-arrow-left"></i> Volver a solicitudes
    </a>
  </div>
</div>

<style>
  @keyframes fade-in {0%{opacity:0;transform:translateY(40px);}100%{opacity:1;transform:none;}}
  .animate-fade-in {animation: fade-in 1.1s cubic-bezier(.6,0,.4,1) forwards;}
  @media (max-width: 600px) {
    #chat-box { max-width: 100vw; min-height: 140px; }
    .rounded-xl { border-radius: 1rem !important; }
    .rounded-lg { border-radius: 0.85rem !important; }
    .px-5 { padding-left: 1.1rem !important; padding-right: 1.1rem !important; }
  }
</style>
{% endblock %}
