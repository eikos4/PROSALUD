{% extends 'base.html' %}
{% block title %}Dashboard Paciente ‚Äì IndepSalud{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-b from-[#e6f7ff] to-[#f0fbff] py-10">
  <div class="max-w-7xl mx-auto px-4">

    <!-- HERO con SaniBot (primera vista del paciente) -->
    <div class="bg-gradient-to-r from-[#007BFF]/90 to-[#00C2FF]/80 rounded-2xl shadow-xl p-8 md:p-10 mb-6 border border-[#007BFF]/10 text-white relative overflow-hidden">
      <!-- decor -->
      <div class="pointer-events-none absolute -top-24 -left-24 w-72 h-72 rounded-full bg-white/10 blur-3xl"></div>
      <div class="pointer-events-none absolute -bottom-24 -right-24 w-80 h-80 rounded-full bg-white/10 blur-3xl"></div>

      <div class="flex flex-col md:flex-row items-start md:items-center gap-8 relative z-10">
        <!-- SaniBot + globo -->
        <div class="flex items-start gap-4 md:w-[44%]">
          <img src="{{ url_for('static', filename='images/sanibot.png') }}" alt="SaniBot"
               class="w-16 h-16 md:w-20 md:h-20 object-contain drop-shadow-2xl animate-[float_4s_ease-in-out_infinite]">
          <div class="bg-white text-[#0d3b66] rounded-2xl px-4 py-3 shadow-xl text-sm max-w-md relative">
            <span class="absolute -left-2 top-5 w-4 h-4 rotate-45 bg-white shadow" aria-hidden="true"></span>
            <p class="font-semibold text-[#007BFF]">¬°Hola! Soy SaniBot üëã</p>
            <p class="mt-1">
              Esta es tu <b>primera vista</b> como paciente. Aqu√≠ podr√°s
              <b>buscar especialistas</b>, <b>filtrar por regi√≥n</b> y <b>enviar mensajes</b>.
            </p>
            <div class="mt-3 flex flex-wrap gap-2">
              <button type="button" id="tourStart"
                class="px-3 py-1.5 rounded-lg bg-[#00C2FF] text-white text-xs font-bold hover:bg-[#00A8D8]">Iniciar tour r√°pido</button>
              <a href="#buscar" class="px-3 py-1.5 rounded-lg border text-[#007BFF] text-xs font-bold hover:bg-white/10">Ir a buscar</a>
              <label class="flex items-center gap-2 text-[12px] text-gray-500 ml-auto">
                <input id="hideCoach" type="checkbox" class="accent-[#007BFF]"> No mostrar de nuevo
              </label>
            </div>
          </div>
        </div>

        <!-- Beneficios -->
        <div class="md:flex-1">
          <h1 class="text-3xl md:text-4xl font-extrabold mb-3 flex items-center gap-3">
            <i class="fas fa-heartbeat text-pink-200"></i>
            Encuentra atenci√≥n m√©dica confiable y cercana
          </h1>
          <p class="text-white/90 font-medium mb-4">Con IndepSalud, accede a una red verificada de profesionales:</p>
          <ul class="space-y-2 text-white/95 text-base pl-1">
            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-300 mt-0.5"></i> Especialistas certificados</li>
            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-300 mt-0.5"></i> Agenda online o presencial</li>
            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-300 mt-0.5"></i> Atenci√≥n r√°pida y segura</li>
            <li class="flex items-start gap-3"><i class="fas fa-check-circle text-green-300 mt-0.5"></i> Califica tu experiencia</li>
          </ul>
          <!-- Atajos -->
          <div class="mt-5 flex flex-wrap gap-3">
            <a href="{{ url_for('main.search') }}"
               class="px-4 py-2 rounded-xl bg-white text-[#007BFF] font-bold shadow hover:shadow-md hover:-translate-y-0.5 transition">
              <i class="fas fa-search mr-2"></i>Buscar especialistas
            </a>
            <a href="{{ url_for('client.appointments') if 'client.appointments' in current_app.view_functions else '#' }}"
               class="px-4 py-2 rounded-xl bg-[#0d3b66] text-white font-bold shadow hover:bg-[#0b2f55] hover:-translate-y-0.5 transition">
              <i class="fas fa-calendar-check mr-2"></i>Mis citas
            </a>
            <a href=""
               class="px-4 py-2 rounded-xl bg-[#00C2FF] text-white font-bold shadow hover:bg-[#0099cc] hover:-translate-y-0.5 transition">
              <i class="fas fa-comment-dots mr-2"></i>Mensajes
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros y b√∫squeda -->
    <form id="buscar" method="GET" class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row md:items-center md:gap-6 mb-8">
      <div class="flex-1 flex flex-col sm:flex-row gap-3">
        <input
          type="text"
          name="q"
          placeholder="Busca un especialista (nombre, especialidad)..."
          value="{{ search_term }}"
          class="flex-1 px-4 py-2 border border-[#00C2FF]/60 bg-[#f0fbff] text-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00C2FF] transition"
        />
        <div class="flex items-center gap-2">
          <label for="region" class="text-sm font-medium text-[#007BFF]">Regi√≥n:</label>
          <select
            id="region"
            name="region"
            class="px-4 py-2 border border-[#00C2FF]/60 bg-[#f0fbff] text-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00C2FF] transition"
            onchange="this.form.submit()"
          >
            <option value="">Todas las Regiones</option>
            {% for r in regions %}
              <option value="{{ r }}" {% if r == selected_region %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="px-5 py-2 bg-[#007BFF] hover:bg-[#005BB5] text-white rounded-lg font-semibold shadow transition">
          <i class="fas fa-search"></i> Buscar
        </button>
      </div>
    </form>

    <!-- Resultados: profesionales -->
    <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
      {% for prof in professionals %}
      <div class="bg-white p-7 rounded-2xl shadow-lg hover:shadow-xl transition border border-gray-200 hover:border-[#00C2FF]/60 group flex flex-col">
        <div class="flex justify-center mb-4">
          <img
            src="{{ prof.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
            alt="{{ prof.username }}"
            class="w-20 h-20 rounded-full border-4 border-[#00C2FF]/40 shadow object-cover group-hover:scale-105 transition"
          />
        </div>
        <div class="text-center flex-1">
          <h3 class="text-xl font-black text-[#007BFF] mb-1 truncate">{{ prof.full_name or prof.username }}</h3>
          {% if prof.location %}
          <div class="text-[#00C2FF] text-xs flex items-center justify-center gap-1 mb-1 font-semibold">
            <i class="fas fa-map-marker-alt"></i> {{ prof.location }}
          </div>
          {% endif %}
          <span class="inline-block px-3 py-1 bg-[#00C2FF]/10 text-[#00C2FF] rounded-full text-xs font-bold mb-2">
            {{ prof.category|capitalize }}
          </span>
          {% if prof.rating %}
            <div class="flex items-center justify-center gap-1 mb-2">
              {% for i in range(1, 6) %}
                {% if i <= prof.rating|round %}
                  <i class="fas fa-star text-yellow-400"></i>
                {% else %}
                  <i class="far fa-star text-gray-300"></i>
                {% endif %}
              {% endfor %}
              <span class="text-xs text-gray-500 ml-1">({{ '%.1f'|format(prof.rating) }})</span>
            </div>
          {% endif %}
          <p class="text-gray-700 text-sm mt-2 mb-4 min-h-[44px]">
            {{ prof.description[:88] if prof.description else 'Sin descripci√≥n' }}{% if prof.description and prof.description|length > 88 %}...{% endif %}
          </p>
        </div>
        <div class="flex flex-col gap-2 mt-auto border-t border-dashed border-[#00C2FF]/20 pt-5">
          <a href="{{ url_for('main.public_profile', id=prof.id) }}"
             class="w-full px-4 py-2 bg-[#007BFF] hover:bg-[#005BB5] text-white rounded-lg text-center text-sm font-semibold shadow transition group-hover:scale-105"
             title="Ver perfil completo">
            <i class="fas fa-user-md"></i> Ver Perfil
          </a>

          {% if prof.services.count() > 0 %}
          <a href="{{ url_for('messages.chat', other_id=prof.id, service_id=prof.services.first().id) }}"
             class="w-full px-4 py-2 bg-[#00C2FF] hover:bg-[#0099cc] text-white rounded-lg text-center text-sm font-semibold shadow transition group-hover:scale-105"
             title="Chatear">
            <i class="fas fa-comment-dots"></i> Mensaje
          </a>
          {% else %}
          <a href="#" class="w-full px-4 py-2 bg-gray-300 text-white rounded-lg text-center text-sm font-semibold shadow" title="No tiene servicios a√∫n" style="pointer-events: none; opacity: 0.7;">
            <i class="fas fa-comment-slash"></i> Mensaje
          </a>
          {% endif %}
        </div>
      </div>
      {% else %}
        <div class="col-span-full text-center p-8 bg-white rounded-2xl border">
          <i class="fas fa-user-slash text-4xl text-gray-400 mb-3"></i>
          <p class="text-gray-600 text-lg">No se encontraron especialistas con tus filtros.</p>
          <div class="mt-3 flex justify-center gap-2">
            <a href="{{ url_for('main.search') }}" class="px-4 py-2 rounded-lg bg-[#007BFF] text-white font-semibold hover:bg-[#005BB5]">Ver todos</a>
            <a href="#buscar" class="px-4 py-2 rounded-lg bg-white border font-semibold text-[#007BFF] hover:bg-blue-50">Cambiar filtros</a>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Modal Tour SaniBot -->
  <div id="tourModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
      <div class="flex items-center gap-3 p-4 border-b">
        <img src="{{ url_for('static', filename='images/sanibot.png') }}" alt="" class="w-8 h-8">
        <h3 class="font-bold text-[#0d3b66]">Tour r√°pido</h3>
      </div>
      <div class="p-5 space-y-4 text-sm text-gray-700">
        <div class="flex gap-3"><i class="fas fa-search text-[#007BFF] mt-0.5"></i> Usa la barra de <b>b√∫squeda</b> para nombre o especialidad.</div>
        <div class="flex gap-3"><i class="fas fa-map-marker-alt text-[#00C2FF] mt-0.5"></i> Filtra por <b>regi√≥n</b> para ver profesionales cercanos.</div>
        <div class="flex gap-3"><i class="fas fa-comment-dots text-emerald-600 mt-0.5"></i> Env√≠a un <b>mensaje</b> o agenda desde el perfil.</div>
        <div class="flex gap-3"><i class="fas fa-star text-yellow-500 mt-0.5"></i> Revisa la <b>reputaci√≥n</b> (estrellas y comentarios).</div>
      </div>
      <div class="p-4 flex justify-between items-center border-t bg-gray-50">
        <label class="text-xs text-gray-500 flex items-center gap-2">
          <input id="dontShowTour" type="checkbox" class="accent-[#007BFF]"> No mostrar de nuevo
        </label>
        <div class="flex gap-2">
          <button type="button" id="tourClose" class="px-4 py-2 text-[#007BFF] font-semibold hover:bg-blue-50 rounded-lg">Cerrar</button>
          <a href="#buscar" class="px-4 py-2 bg-[#007BFF] text-white font-semibold rounded-lg hover:bg-[#005BB5]">Ir a buscar</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- JS SaniBot: coachmark, tour, preferencias -->
<script>
(function () {
  const LS_KEY_COACH = 'hide_patient_coach';
  const LS_KEY_TOUR = 'hide_patient_tour';

  const tourBtn = document.getElementById('tourStart');
  const tourModal = document.getElementById('tourModal');
  const tourClose = document.getElementById('tourClose');
  const dontShowTour = document.getElementById('dontShowTour');
  const hideCoach = document.getElementById('hideCoach');

  // Ocultar globo si el usuario lo marc√≥ antes
  if (localStorage.getItem(LS_KEY_COACH) === '1') {
    hideCoach?.closest('.bg-white')?.classList.add('hidden');
  }

  hideCoach?.addEventListener('change', function(){
    if (this.checked) localStorage.setItem(LS_KEY_COACH, '1');
    else localStorage.removeItem(LS_KEY_COACH);
  });

  function openTour(){
    if (!tourModal) return;
    tourModal.classList.remove('hidden');
    tourModal.classList.add('flex');
  }
  function closeTour(){
    if (!tourModal) return;
    tourModal.classList.add('hidden');
    tourModal.classList.remove('flex');
  }

  // Mostrar tour si no se ocult√≥ previamente (primera vez)
  if (localStorage.getItem(LS_KEY_TOUR) !== '1') {
    setTimeout(openTour, 400); // abre suave al cargar
  }

  tourBtn?.addEventListener('click', openTour);
  tourClose?.addEventListener('click', closeTour);
  tourModal?.addEventListener('click', (e)=>{ if(e.target === tourModal) closeTour(); });
  dontShowTour?.addEventListener('change', function(){
    if (this.checked) localStorage.setItem(LS_KEY_TOUR, '1');
    else localStorage.removeItem(LS_KEY_TOUR);
  });
})();
</script>

<style>
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
</style>
{% endblock %}
