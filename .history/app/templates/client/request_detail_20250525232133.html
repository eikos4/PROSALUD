{% extends 'base.html' %}
{% block title %}Detalle de solicitud{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto py-10 px-4 animate-fade-in">
  <h2 class="text-3xl font-bold text-[#276EF1] mb-7 flex items-center gap-2">
    <i class="fas fa-handshake"></i> Detalle de Solicitud
  </h2>

  <!-- DATOS PRINCIPALES -->
  <div class="bg-white rounded-xl shadow p-7 mb-8 flex flex-col gap-3">
    <div>
      <span class="font-semibold text-[#164399]">Profesional:</span>
      <span class="flex items-center gap-2">
        <img src="{{ req.service.professional.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
             class="w-8 h-8 rounded-full border-2 border-[#276EF1]/30 object-cover" alt="avatar">
        <span class="text-[#164399] font-semibold">{{ req.service.professional.full_name or req.service.professional.username }}</span>
      </span>
    </div>
    <div>
      <span class="font-semibold text-[#164399]">Servicio:</span>
      <span class="text-gray-700 font-semibold">{{ req.service.title }}</span>
      <div class="text-gray-600 text-sm">{{ req.service.description }}</div>
    </div>
    <div>
      <span class="font-semibold text-[#164399]">Estado:</span>
      {% if req.status == 'pending' %}
        <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full font-bold text-xs">Pendiente</span>
      {% elif req.status == 'accepted' %}
        <span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full font-bold text-xs">Aceptada</span>
      {% elif req.status == 'rejected' %}
        <span class="inline-block px-3 py-1 bg-red-100 text-red-700 rounded-full font-bold text-xs">Rechazada</span>
      {% elif req.status == 'completed' %}
        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-bold text-xs">Completada</span>
      {% endif %}
    </div>
    <div>
      <span class="font-semibold text-[#164399]">Fecha de solicitud:</span>
      <span class="text-gray-700">{{ req.date_requested.strftime('%d-%m-%Y %H:%M') }}</span>
    </div>
    <!-- OPCIÓN DE DEJAR RESEÑA -->
    {% if req.status == 'completed' and not evaluation_exists %}
      <div class="mt-4">
        <a href="{{ url_for('client.evaluate', request_id=req.id) }}"
           class="inline-block px-7 py-3 bg-gradient-to-r from-[#FF8800] to-[#276EF1] hover:from-[#CC7700] hover:to-[#1E5BB8] text-white rounded-full font-extrabold text-lg shadow transition">
          <i class="fas fa-star mr-2"></i> Dejar reseña al profesional
        </a>
      </div>
    {% elif req.status == 'completed' and evaluation_exists %}
      <div class="mt-4">
        <span class="inline-block px-4 py-2 bg-green-100 text-green-700 rounded font-semibold shadow">
          Ya enviaste una reseña para este servicio.
        </span>
      </div>
    {% endif %}
  </div>

  <!-- CHAT -->



  <div class="max-w-3xl mx-auto py-8">
  <h2 class="text-2xl font-bold mb-6 text-[#276EF1] flex items-center gap-2">
    <i class="fas fa-comments"></i>
    Chat con {{ other_user.username }}
  </h2>
  <div id="chat-box" class="bg-white rounded-lg p-5 shadow mb-6 min-h-[300px] max-h-[420px] overflow-y-auto">
    {% if convo|length == 0 %}
      <div class="text-gray-400 text-center my-8">
        <i class="fas fa-comment-dots text-4xl mb-2"></i>
        <p>No hay mensajes aún. ¡Comienza la conversación!</p>
      </div>
    {% endif %}
    {% for msg in convo %}
      <div class="mb-2 flex {% if msg.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %}">
        {% if msg.sender_id != current_user.id %}
          <img src="{{ other_user.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
               alt="{{ other_user.username }}"
               class="w-7 h-7 rounded-full border-2 border-[#FF8800]/30 mr-2 mt-1 hidden sm:inline-block">
        {% endif %}
        <div class="inline-block px-5 py-3 rounded-2xl max-w-xs shadow
          {% if msg.sender_id == current_user.id %}
            bg-gradient-to-br from-[#276EF1] to-[#4bb3fd] text-white
          {% else %}
            bg-gray-200 text-gray-800
          {% endif %}">
          <span class="block font-semibold text-xs mb-1 opacity-70">
            {% if msg.sender_id == current_user.id %}Tú{% else %}{{ other_user.username }}{% endif %}
          </span>
          <span class="block">{{ msg.body }}</span>
          <span class="block text-[10px] text-gray-400 mt-1 text-right">{{ msg.timestamp.strftime('%d-%m-%Y %H:%M') }}</span>
        </div>
      </div>
    {% endfor %}
  </div>
  <form method="POST" class="flex gap-2">
    {{ form.hidden_tag() }}
    {{ form.body(class_="flex-1 px-4 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-[#276EF1] bg-white text-gray-900", rows="2", placeholder="Escribe un mensaje...") }}
    <button type="submit" class="px-5 py-2 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded font-semibold flex items-center gap-2">
      <i class="fas fa-paper-plane"></i> Enviar
    </button>
  </form>
</div>
  <h3 class="text-xl font-bold text-[#FF8800] mb-3 flex items-center gap-2">
    <i class="fas fa-comments"></i> Conversación
  </h3>
  <div class="bg-[#f5f7fc] rounded-xl p-5 mb-6 max-h-72 overflow-y-auto">
    {% if messages %}
      {% for msg in messages %}
        <div class="mb-2 flex {% if msg.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %}">
          <div class="inline-block px-4 py-2 rounded-2xl shadow
            {% if msg.sender_id == current_user.id %}
              bg-[#e6eefa] text-[#164399] border border-[#276EF1]/10
            {% else %}
              bg-white text-gray-800 border border-gray-200
            {% endif %}">
            <div class="text-sm font-medium">{{ msg.body }}</div>
            <div class="text-xs text-gray-400 mt-1 {% if msg.sender_id == current_user.id %}text-right{% endif %}">
              {{ msg.timestamp.strftime('%d-%m-%Y %H:%M') }}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-gray-500 text-center py-4">No hay mensajes aún.</div>
    {% endif %}
  </div>

  <!-- FORM NUEVO MENSAJE -->
  <form method="POST" class="bg-white rounded-xl shadow p-6 flex gap-3 items-end">
    {{ form.hidden_tag() }}
    <div class="flex-1">
      {{ form.body.label(class_="block text-[#164399] font-semibold mb-1") }}
      {{ form.body(
          class_="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#276EF1] bg-white text-gray-900",
          rows="3",
          placeholder="Escribe tu mensaje..."
      ) }}
      {% if form.body.errors %}
        <div class="text-red-500 text-xs mt-1">{{ form.body.errors[0] }}</div>
      {% endif %}
    </div>
    <button type="submit" class="h-12 px-7 bg-[#FF8800] hover:bg-[#CC7700] text-white rounded-lg font-bold shadow flex items-center gap-2">
      <i class="fas fa-paper-plane"></i> Enviar
    </button>
  </form>

  <div class="mt-6">
    <a href="{{ url_for('client.my_requests') }}"
       class="inline-block px-6 py-2 bg-[#276EF1] hover:bg-[#1E5BB8] text-white rounded-lg font-semibold transition mt-8">
      <i class="fas fa-arrow-left"></i> Volver a solicitudes
    </a>
  </div>
</div>

<style>
  @keyframes fade-in {0%{opacity:0;transform:translateY(40px);}100%{opacity:1;transform:none;}}
  .animate-fade-in {animation: fade-in 1.1s cubic-bezier(.6,0,.4,1) forwards;}
</style>
{% endblock %}
