{% extends 'base.html' %}
{% block title %}Explora Profesionales – IndepSalud{% endblock %}

{% block content %}
<section class="relative min-h-screen bg-gradient-to-b from-[#f8fbff] via-[#e8f1ff] to-white py-16 overflow-hidden">

  <!-- 💬 SANIBOT -->
  <div id="sanibot-bubble" class="fixed bottom-6 right-6 z-20 animate-bounce transition-opacity duration-500">
    <div class="relative bg-white shadow-xl rounded-2xl px-4 py-3 border border-[#276EF1]/20 max-w-[280px] w-[90vw] sm:w-auto">
      <!-- Botón cerrar -->
      <button onclick="hideSanibot()" class="absolute -top-2 -right-2 bg-[#276EF1] text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow hover:bg-[#164399] transition">
        ✕
      </button>

      <div class="flex items-start gap-3">
        <img src="{{ url_for('static', filename='images/Sanibot.png') }}"
             class="w-12 h-12 object-contain" alt="Sanibot">
        <p class="text-gray-700 text-sm leading-snug">
          <strong>¡Hola! Soy Sanibot 🤖</strong><br>
          Te ayudo a encontrar los <span class="text-[#276EF1] font-semibold">mejores profesionales certificados</span> según tu necesidad.
        </p>
      </div>
    </div>
  </div>

  <!-- 🩺 HERO / BUSCADOR -->
  <div class="max-w-5xl mx-auto text-center mb-20 px-6">
    <h1 class="text-4xl md:text-5xl font-extrabold text-[#164399] mb-4">
      Encuentra profesionales de <span class="text-[#276EF1]">salud certificados</span>
    </h1>
    <p class="text-gray-600 mb-8 text-lg">Agenda consultas presenciales o virtuales con especialistas validados.</p>

    <form method="GET" action="{{ url_for('main.search') }}" class="flex flex-col md:flex-row gap-3 justify-center">
      <input
        type="text"
        name="q"
        value="{{ request.args.get('q','') }}"
        placeholder="Ej: Psicólogo, Nutricionista, Pediatra..."
        class="w-full md:w-[420px] px-5 py-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-[#276EF1] focus:outline-none text-gray-800 shadow"
      >
      <button
        type="submit"
        class="px-8 py-3 bg-[#276EF1] hover:bg-[#164399] text-white font-bold rounded-full shadow transition">
        <i class="fas fa-search mr-2"></i>Buscar
      </button>
    </form>
  </div>

  <!-- 🔝 PROFESIONALES DESTACADOS -->
  <div class="max-w-7xl mx-auto px-6 space-y-16">

    {% set total = top_professionals|map(attribute='1')|map('length')|sum %}
    {% if total == 0 %}
      <!-- 🩺 MENSAJE SI NO HAY PROFESIONALES -->
      <div class="text-center py-24">
        <img src="{{ url_for('static', filename='images/no-results.svg') }}" alt="Sin resultados" class="w-44 mx-auto mb-6 opacity-90">
        <h2 class="text-2xl font-bold text-[#164399] mb-2">No hay profesionales registrados aún</h2>
        <p class="text-gray-600 mb-6">Estamos validando nuevos especialistas certificados para unirte pronto a nuestra red.</p>
        <a href="{{ url_for('main.index') }}" class="inline-block px-6 py-3 bg-[#276EF1] text-white rounded-full font-semibold hover:bg-[#164399] transition">
          <i class="fas fa-arrow-left mr-2"></i>Volver al inicio
        </a>
      </div>

    {% else %}
      {% for category, professionals in top_professionals.items() %}
        {% if professionals %}
        <div class="bg-white rounded-3xl shadow-lg border border-[#276EF1]/10 p-8 animate-fade-in">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-[#276EF1] flex items-center gap-2">
              <i class="fas fa-stethoscope text-[#FF8800]"></i> {{ category|capitalize }}
            </h2>
            <a href="{{ url_for('main.search', q=category) }}"
               class="text-sm text-[#164399] hover:text-[#276EF1] font-semibold">
               Ver todos <i class="fas fa-arrow-right ml-1"></i>
            </a>
          </div>

          <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
            {% for user in professionals %}
            <div class="bg-gradient-to-b from-[#f9fbff] to-[#eef4ff] rounded-2xl shadow-md hover:shadow-xl p-6 flex flex-col items-center border border-[#276EF1]/10 transition">
              <img
                src="{{ user.profile_image_url or url_for('static', filename='images/placeholder.png') }}"
                alt="{{ user.username }}"
                class="w-24 h-24 rounded-full border-4 border-[#FF8800]/30 shadow mb-4 object-cover"
              >
              <h3 class="text-lg font-bold text-[#164399] mb-1">{{ user.full_name or user.username }}</h3>

              {% if user.location %}
                <p class="text-[#FF8800] text-sm font-semibold flex items-center gap-1">
                  <i class="fas fa-map-marker-alt"></i> {{ user.location }}
                </p>
              {% endif %}

              <p class="text-gray-600 text-sm mt-2 text-center line-clamp-3">
                {{ user.description or 'Sin descripción disponible' }}
              </p>

              <!-- Botones -->
              <div class="mt-4 flex gap-3">
                <a href="{{ url_for('main.public_profile', id=user.id) }}"
                   class="px-5 py-2 bg-[#276EF1] text-white rounded-full text-sm font-semibold hover:bg-[#164399] transition shadow">
                   Ver Perfil
                </a>

                {% set primer_servicio = user.services.first() %}
                {% if primer_servicio %}
                  <a href="{{ url_for('messages.chat', other_id=user.id, service_id=primer_servicio.id) }}"
                     class="px-5 py-2 bg-[#FF8800] text-white rounded-full text-sm font-semibold hover:bg-[#e67300] transition shadow">
                     Chat
                  </a>
                {% else %}
                  <span class="px-5 py-2 bg-gray-200 text-gray-500 rounded-full text-sm font-semibold shadow cursor-not-allowed">
                    Sin servicio
                  </span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
</section>

<!-- 💻 Scripts -->
<script>
  // Ocultar y guardar preferencia
  function hideSanibot() {
    const bubble = document.getElementById('sanibot-bubble');
    bubble.classList.add('opacity-0', 'translate-y-5');
    setTimeout(() => bubble.style.display = 'none', 400);
    localStorage.setItem('hideSanibot', 'true');
  }

  // Mostrar solo si el usuario no lo ocultó antes
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('hideSanibot') === 'true') {
      document.getElementById('sanibot-bubble').style.display = 'none';
    }
  });
</script>

<style>
  @keyframes fade-in {0%{opacity:0;transform:translateY(40px);}100%{opacity:1;transform:none;}}
  .animate-fade-in {animation: fade-in 1.1s ease forwards;}
  .line-clamp-3 {display: -webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
</style>
{% endblock %}
